ets.load(["id","position"]),o=(0,f.addTraceMessage)(e),s=e.workbook.worksheets.getActiveWorksheet().load("id"),[4,e.sync().then((function(){return s.id}),(function(e){if((0,f.hasTraceMessage)(e,o))return"";throw e}))];case 1:return c=i.sent(),n.isNullObject?((0,u.getLogger)().sendError(d.ErrorCode.SheetsUpdateFailed,d.ErrorSeverity.Low),[2]):(h=this.sink.addSheet(t,n.name,(0,a.getVisibility)(n.visibility),n.position),r.items.forEach((function(e){return m.sink.updateSheetPosition(e.id,e.position)})),this.sink.activateSheet(c),p=new l.XlObjectSource(h,t,this.objectCounter),this.objectPipelines[t]={source:p,sink:h},[2])}}))}))}))}))];case 2:return m.sent(),(n=this.objectPipelines[t].source)?[4,n.enable()]:[3,4];case 3:m.sent(),m.label=4;case 4:return[3,6];case 5:return s=m.sent(),c=r(r({},(0,d.getFieldsForPossibleError)(s)),{handler:"handleSheetAdded"}),(0,u.getLogger)().sendError(d.ErrorCode.SheetsUpdateFailed,d.ErrorSeverity.Medium,c),[3,6];case 6:return[2]}}))}))},e.prototype.handleSheetDeleted=function(e){this.sink.removeSheet(e.worksheetId);var t=this.objectPipelines[e.worksheetId];return t&&(t.source.disable(),delete this.objectPipelines[e.worksheetId]),Promise.resolve()},e.prototype.handleSheetActivated=function(e){return this.sink.activateSheet(e.worksheetId),this.objectPipelines[e.worksheetId].source.resumeTimer(),Promise.resolve()},e.prototype.handleSheetDeactivated=function(e){return this.sink.deactivateSheet(e.worksheetId),Promise.resolve()},e.prototype.handleSheetNameChanged=function(e){return this.sink.updateSheetName(e.worksheetId,e.nameAfter),Promise.resolve()},e.prototype.handleSheetVisibilityChanged=function(e){return this.sink.updateSheetVisibility(e.worksheetId,(0,a.getVisibility)(e.visibilityAfter)),Promise.resolve()},e.prototype.handleSheetMoved=function(){var e=this;return h.xlRequestPool.add((function(){return Excel.run({delayForCellEdit:!0},(function(t){var n=t.workbook.worksheets.load(["id","position"]);return t.sync().then((function(){n.items.forEach((function(t){return e.sink.updateSheetPosition(t.id,t.position)}))}))}))}))},e.prototype.handleWorkbookNameAdded=function(e){var t=this;return h.xlRequestPool.add((function(){return Excel.run({delayForCellEdit:!0},(function(n){var o=n.workbook.names.getItem(e.namedItemName).load(["name","type","scope","visible"]),i=o.getRangeOrNullObject().load(["worksheet/id","left","top","width","height","isNullObject","addressLocal"]);return n.sync().then((function(){if(o.type===Excel.NamedItemType.range&&o.visible&&!i.isNullObject){var e=i.worksheet.id,n={objectType:m.SheetObjectType.NamedRange,id:(0,b.getIdForName)(o.name,o.scope),name:o.name,x:i.left,y:i.top,address:i.addressLocal},r=t.objectPipelines[e];r&&(r.sink.addObject(n),r.source.update())}})).catch((function(e){var t=r(r({},(0,d.getFieldsForPossibleError)(e)),{handler:"handleWorkbookNameAdded"});(0,u.getLogger)().sendError(d.ErrorCode.ObjectsUpdateFailed,d.ErrorSeverity.Medium,t)}))}))}))},e.prototype.handleWorkbookNameDeleted=function(e){return this.objectPipelines[0].sink.removeObject(e.namedItemName),Promise.resolve()},e.prototype.handleUpdateTimer=function(){var e=this;(0,p.getFlightedBool)("noPolling")||h.xlRequestPool.add((function(){return Excel.run({delayForCellEdit:!0},(function(t){return o(e,void 0,void 0,(function(){var e,n,o,l,c=this;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,(0,a.getSheetIds)(t)];case 1:return e=i.sent(),[4,(0,s.getNamedRangeObjectsForBook)(t)];case 2:return n=i.sent(),e.forEach((function(e){var t,r=n[e]||[],o=null===(t=c.objectPipelines[e])||void 0===t?void 0:t.sink;o&&(o.beginUpdateObjects(!0),r.forEach((function(e){return o.updateObject(e)})),o.endUpdateObjects())})),setTimeout((function(){return c.handleUpdateTimer()}),this.updateTimerDelay),[3,4];case 3:return o=i.sent(),l=r(r({},(0,d.getFieldsForPossibleError)(o)),{handler:"xlSheetSource.handleUpdateTimer"}),(0,u.getLogger)().sendError(d.ErrorCode.SheetsUpdateFailed,d.ErrorSeverity.Medium,l),[3,4];case 4:return[2]}}))}))}))}))},e}();t.XlSheetSource=g},function(e,t,n){"use strict";a zip file")
                return False

        finally:
            shutil.rmtree(td)

        return True


def check(source_dir):
    pyproject = pjoin(source_dir, 'pyproject.toml')
    if isfile(pyproject):
        log.info('Found pyproject.toml')
    else:
        log.error('Missing pyproject.toml')
        return False

    try:
        with open(pyproject, 'rb') as f:
            pyproject_data = tomllib.load(f)
        # Ensure the mandatory data can be loaded
        buildsys = pyproject_data['build-system']
        requires = buildsys['requires']
        backend = buildsys['build-backend']
        backend_path = buildsys.get('backend-path')
        log.info('Loaded pyproject.toml')
    except (tomllib.TOMLDecodeError, KeyError):
        log.error("Invalid pyproject.toml", exc_info=True)
        return False

    hooks = Pep517HookCaller(source_dir, backend, backend_path)

    sdist_ok = check_build_sdist(hooks, requires)
    wheel_ok = check_build_wheel(hooks, requires)

    if not sdist_ok:
        log.warning('Sdist checks failed; scroll up to see')
    if not wheel_ok:
        log.warning('Wheel checks failed')

    return sdist_ok


def main(argv=None):
    log.warning('pep517.check is deprecated. '
                'Consider switching to https://pypi.org/project/build/')

    ap = argparse.ArgumentParser()
    ap.add_argument(
        'source_dir',
        help="A directory containing pyproject.toml")
    args = ap.parse_args(argv)

    enable_colourful_output()

    ok = check(args.source_dir)

    if ok:
        print(ansi('Checks passed', 'green'))
    else:
        print(ansi('Checks failed', 'red'))
        sys.exit(1)


ansi_codes = {
    'reset': '\x1b[0m',
    'bold': '\x1b[1m',
    'red': '\x1b[31m',
    'green': '\x1b[32m',
}


def ansi(s, attr):
    if os.name != 'nt' and sys.stdout.isatty():
        return ansi_codes[attr] + str(s) + ansi_codes['reset']
    else:
        return str(s)


if __name__ == '__main__':
    main()
