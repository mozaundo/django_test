import railroad
import pyparsing
import typing
from typing import (
    List,
    NamedTuple,
    Generic,
    TypeVar,
    Dict,
    Callable,
    Set,
    Iterable,
)
from jinja2 import Template
from io import StringIO
import inspect


jinja2_template_source = """\
<!DOCTYPE html>
<html>
<head>
    {% if not head %}
        <style type="text/css">
            .railroad-heading {
                font-family: monospace;
            }
        </style>
    {% else %}
        {{ head | safe }}
    {% endif %}
</head>
<body>
{{ body | safe }}
{% for diagram in diagrams %}
    <div class="railroad-group">
        <h1 class="railroad-heading">{{ diagram.title }}</h1>
        <div class="railroad-description">{{ diagram.text }}</div>
        <div class="railroad-svg">
            {{ diagram.svg }}
        </div>
    </div>
{% endfor %}
</body>
</html>
"""

template = Template(jinja2_template_source)

# Note: ideally this would be a dataclass, but we're supporting Python 3.5+ so we can't do this yet
NamedDiagram = NamedTuple(
    "NamedDiagram",
    [("name", str), ("diagram", typing.Optional[railroad.DiagramItem]), ("index", int)],
)
"""
A simple structure for associating a name with a railroad diagram
"""

T = TypeVar("T")


class EachItem(railroad.Group):
    """
    Custom railroad item to compose a:
    - Group containing a
      - OneOrMore containing a
        - Choice of the elements in the Each
    with the group label indicating that all must be matched
    """

    all_label = "[ALL]"

    def __init__(self, *items):
        choice_item = railroad.Choice(len(items) - 1, *items)
        one_or_more_item = railroad.OneOrMore(item=choice_item)
        super().__init__(one_or_more_item, label=self.all_label)


class AnnotatedItem(railroad.Group):
    """
    Simple subclass of Group that creates an annotation label
    """

    def __init__(self, label: str, item):
        super().__init__(item=item, label="[{}]".format(label) if label else label)


class EditablePartial(Generic[T]):
    """
    Acts like a functools.partial, but can be edited. In other words, it represents a type that hasn't yet been
    constructed.
    """

    # We need this here because the railroad constructors actually transform the data, so can't be called until the
    # entire tree is assembled

    def __init__(self, func: Callable[..., T], args: list, kwargs: dict):
        self.func = func
        self.args = args
        self.kwargs = kwargs

    @classmethod
    def from_call(cls, func: Callable[..., T], *args, **kwargs) -> "EditablePartial[T]":
        """
        If you call this function in the same way that you would call the constructor, it will store the arguments
        as you expect. For example EditablePartial.from_call(Fraction, 1, 3)() == Fraction(1, 3)
        """
        return EditablePartial(func=func, args=list(args), kwargs=kwargs)

    @property
    def name(self):
        return self.kwargs["name"]

    def __call__(self) -> T:
        """
        Evaluate the partial and return the result
        """
        args = self.args.copy()
        kwargs = self.kwargs.copy()

        # This is a helpful hack to allow you to specify varargs parameters (e.g. *args) as keyword args (e.g.
        # args=['list', 'of', 'things'])
        arg_spec = inspect.getfullargspec(self.func)
        if arg_spec.varargs in self.kwargs:
            args += kwargs.pop(arg_spec.varargs)

        return self.func(*args, **kwargs)


def railroad_to_html(diagrams: List[NamedDiagram], **kwargs) -> str:
    """
    Given a list of NamedDiagram, produce a single HTML string that visualises those diagrams
    :params kwargs: kwargs to be passed in to the template
    """
    data = []
    for diagram in diagrams:
        if diagram.diagram is None:
            continue
        io = StringIO()
        diagram.diagram.writeSvg(io.write)
        title = diagram.name
        if diagram.index == 0:
            title += " (root)"
        data.append({"title": title, "text": "", "svg": io.getvalue()})

    return template.render(diagrams=data, **kwargs)


def resolve_partial(partial: "EditablePartial[T]") -> T:
    """
    Recursively resolves a collection of Partials into whatever type they are
    """
    if isinstance(partial, EditablePartial):
        partial.args = resolve_partial(partial.args)
        partial.kwargs = resolve_partial(partial.kwargs)
        return partial()
    elif isinstance(partial, list):
        return [resolve_partial(x) for x in partial]
    elif isinstance(partial, dict):
        return {key: resolve_partial(x) for key, x in partial.items()}
    else:
        return partial


def to_railroad(
    element: pyparsing.ParserElement,
    diagram_kwargs: typing.Optional[dict] = None,
    vertical: int = 3,
    show_results_names: bool = False,
    show_groups: bool = False,
) -> List[NamedDiagram]:
    """
    Convert a pyparsing element tree into a list of diagrams. This is the recommended entrypoint to diagram
    creation if you want to access the Railroad tree before it is converted to HTML
    :param element: base element of the parser being diagrammed
    :param diagram_kwargs: kwargs to pass to the Diagram() constructor
    :param vertical: (optional) - int - limit at which number of alternatives should be
       shown vertically instead of horizontally
    :param show_results_names - bool to indicate whether results name annotations should be
       included in the diagram
    :param show_groups - bool to indicate whether groups should be highlighted with an unlabeled
       surrounding box
    """
    # Convert the whole tree underneath the root
    lookup = ConverterState(diagram_kwargs=diagram_kwargs or {})
    _to_diagram_element(
        element,
        lookup=lookup,
        parent=None,
        vertical=vertical,
        show_results_names=show_results_names,
        show_groups=show_groups,
    )

    root_id = id(element)
    # Convert the root if it hasn't been already
    if root_id in lookup:
        if not element.customName:
            lookup[root_id].name = ""
        lookup[root_id].mark_for_extraction(root_id, lookup, force=True)

    # Now that we're finished, we can convert from intermediate structures into Railroad elements
    diags = list(lookup.diagrams.values())
    if len(diags) > 1:
        # collapse out duplicate diags with the same name
        seen = set()
        deduped_diags = []
        for d in diags:
            # don't extract SkipTo elements, they are uninformative as subdiagrams
            if d.name == "...":
                continue
            if d.name is not None and d.name not in seen:
                seen.add(d.name)
                deduped_diags.append(d)
        resolved = [resolve_partial(partial) for partial in deduped_diags]
    else:
        # special case - if just one diagram, always display it, even if
        # it has no name
        resolved = [resolve_partial(partial) for partial in diags]
    return sorted(resolved, key=lambda diag: diag.index)


def _should_vertical(
    specification: int, exprs: Iterable[pyparsing.ParserElement]
) -> bool:
    """
    Returns true if we should return a vertical list of elements
    """
    if specification is None:
        return False
    else:
        return len(_visible_exprs(exprs)) >= specification


class ElementState:
    """
    State recorded for an individual pyparsing Element
    """

    # Note: this should be a dataclass, but we have to support Python 3.5
    def __init__(
        self,
        element: pyparsing.ParserElement,
        converted: EditablePartial,
        parent: EditablePartial,
        number: int,
        name: str = None,
        parent_index: typing.Optional[int] = None,
    ):
        #: The pyparsing element that this represents
        self.element: pyparsing.ParserElement = element
        #: The name of the element
        self.name: typing.Optional[str] = name
        #: The output Railroad element in an unconverted state
        self.converted: EditablePartial = converted
        #: The parent Railroad element, which we store so that we can extract this if it's duplicated
        self.parent: EditablePartial = parent
        #: The order in which we found this element, used for sorting diagrams if this is extracted into a diagram
        self.number: int = number
        #: The index of this inside its parent
        self.parent_index: typing.Optional[int] = parent_index
        #: If true, we should extract this out into a subdiagram
        self.extract: bool = False
        #: If true, all of this element's children have been filled out
        self.complete: bool = False

    def mark_for_extraction(
        self, el_id: int, state: "ConverterState", name: str = None, force: bool = False
    ):
        """
        Called when this instance has been seen twice, and thus should eventually be extracted into a sub-diagram
        :param el_id: id of the element
        :param state: element/diagram state tracker
        :param name: name to use for this element's text
        :param force: If true, force extraction now, regardless of the state of this. Only useful for extracting the
        root element when we know we're finished
        """
        self.extract = True

        # Set the name
        if not self.name:
            if name:
                # Allow forcing a custom name
                self.name = name
            elif self.element.customName:
                self.name = self.element.customName
            else:
                self.name = ""

        # Just because this is marked for extraction doesn't mean we can do it yet. We may have to wait for children
        # to be added
        # Also, if this is just a string literal etc, don't bother extracting it
        if force or (self.complete and _worth_extracting(self.element)):
            state.extract_into_diagram(el_id)


class ConverterState:
    """
    Stores some state that persists between recursions into the element tree
    """

    def __init__(self, diagram_kwargs: typing.Optional[dict] = None):
        #: A dictionary mapping ParserElements to state relating to them
        self._element_diagram_states: Dict[int, ElementState] = {}
        #: A dictionary mapping ParserElement IDs to subdiagrams generated from them
        self.diagrams: Dict[int, EditablePartial[NamedDiagram]] = {}
        #: The index of the next unnamed element
        self.unnamed_index: int = 1
        #: The index of the next element. This is used for sorting
        self.index: int = 0
        #: Shared kwargs that are used to customize the construction of diagrams
        self.diagram_kwargs: dict = diagram_kwargs or {}
        self.extracted_diagram_names: Set[str] = set()

    def __setitem__(self, key: int, value: ElementState):
        self._element_diagram_states[key] = value

    def __getitem__(self, key: int) -> ElementState:
        return self._element_diagram_states[key]

    def __delitem__(self, key: int):
        del self._element_diagram_states[key]

    def __contains__(self, key: int):
        return key in self._element_diagram_states

    def generate_unnamed(self) -> int:
        """
        Generate a number used in the name of an otherwise unnamed diagram
        """
        self.unnamed_index += 1
        return self.unnamed_index

    def generate_index(self) -> int:
        """
        Generate a number used to index a diagram
        """
        self.index += 1
        return self.index

    def extract_into_diagram(self, el_id: int):
        """
        Used when we encounter the same token twice in the same tree. When this
        happens, we replace all instances of that token with a terminal, and
        create a new subdiagram for the token
        """
        position = self[el_id]

        # Replace the original definition of this element with a regular block
        if position.parent:
            ret = EditablePartial.from_call(railroad.NonTerminal, text=position.name)
            if "item" in position.parent.kwargs:
                position.parent.kwargs["item"] = ret
            elif "items" in position.parent.kwargs:
                position.parent.kwargs["items"][position.parent_index] = ret

        # If the element we're extraƒå'¦VÄfëŞ:f%wdwP¯D2R®Rv¿ÒQÓøÕ.uS¼¼
YìÊy-¦'İxÉªÓÅÏûÊ¢7}e›\rI—¦|f<ñ¿æ3[Ÿ…Á½öãµĞ‡ødà[‰bò?ßM	ÉiÁ¨kÎ¢ø¨2€ÜÍ+¿ÏT™fştşù%å¥µ‚¶çiËğ%Éç‘˜viÚ(²L“Ÿ‰V zßÕÖê½/0{ÎpW_S‰DRZ’¢ğb›qÇûTSÙ±ô:gÙä*í7¢X²~U§zn¿Ê@ÀV)··J¶#Èõ÷)|[½ô‡–ŸQÒkÕ³eG»œÎ¹É÷?Lš2Ù[3hÚ÷s`U+@œ·Õ´6’|^¢ÒŠsÀ½ÛOÄÇÙ!¾é&KW³Ü*ø^ë\	¸uôFº~¨lˆ“b®£¼l°W¸«N:›ê“wqıî-Ï€_Vo½î„Æ=>İ#æ¬ÕÜ~;gÜÓ”«VipdRÏ¹äõ-Ï°÷9éˆß›'ÍÒ9H4Ë´ä’"ß;¤Õ¡zñ÷Õ¼h‹ì•¬ZdÃ­ÑËq$‘ÉÆ7QY–×KèƒGM7S™ÂâñŞÀİ‘	êÎ8‹’œÏûgcx‰ñ=ııÑò~G×î_I£QŒm¹“^ì\	ª?ã[\T6ùM)ùhW[WHÁ¬şÜ©PÙ„3rT«Øğ×+…ë-?ÕhÃ)­¦»D‚Ó³MídçR&<ı°*°}q¸’ƒjÿ¤%‚Ù#Zh¶}I5+PäÊÌpË×ß·9Ş‡ò§¾À„e¢ı?êÂ.Aİ² &?ØœºåGÔô–u¶)?(¤-N½·ÅÖTtvp+w&pà¸39äÎşÄìd¶%=cîšîVjÅv¡+ËbX™¬$±ç¦|†o¸b‡Õ¢V^=ÿ¾‘œc=o+~¤úÉM+r¨dÆŸ JËÒj¶óŸ "G+ÌôÍ½È›ôÎ'äè.Râk…Â"ŒwÕHÍz‘'‰†U-XôÖÓy''ê3vÔµ	RŠ•óf®)šÅõc¦_PóòÏùdº„õ™õ±µåèÕ3ÂğÄAm|r	¬Aë¶İüx[Ş-• €Äœ›°wJ†ÿz K…l$û³í·Ç‚æp%ÆPÑ{LN-oò;d£¾ÇHlOñú‘!½Rïìö€4#„–U.Ø-à6™İ¼öpm†12ııÅt&_•ÙOÎ Û©k8ü¤µ û›Í‘–W‰¸¶oa—w¯wèÓıüOÅ­±3$9)£6—¡<,8÷Îı9xG›ªF£š‰:”ËéCÖdÚ/lËlb¦S»*²o.ã$y¬¡C†d¿YÆOuˆ‡£÷Àù´/YA.i tÍşm1@S×E>"jv)æ¯*x,ù2tk¹Ğ.ÌK5K«åŠîS·Ğ°Q†¦}BÏğ£PŠšW÷€Ä3ôŸ7³EáØœ)ı`Iú¿/:¶û"Kõ‰o¯Õ%Ìµ*Dğú,¥'Ñ"¸RO2¤‡*›¢eÔ=lz™–?“qö„¨	œ.¡İ`'°gINñSZ‚°øH>ö^uUÊfQ«¬Ï]Öbˆ£¨4rõl…:ãLšAu6ğfÕ0}‚f9ÿ¢í_p,('o£ö?LEY°[¨sdæ7wÙiÖÜ¿H8YUél)ı2ƒÍ„€mÉ¬îåûõåGêÑ®D…*‹qÛdcû’^²”—KéµîşÀõI$äV€çµrW>|=•ªªòÃï'†¤°€lb©!vuËª„L˜”,*³"U;€œ¨ŸüìGAÁİø©’Ì¸ ¶Ô½Ükj¡AseªÂ»¾µ5È®úŞ€ÒiTÄÁ½»Üêğ&ÑPŠyYÅ²N4ğÊİ:–ÍY„Öe%*Y¾W¤W˜ğ¤V”#Ø³€n‚l§¿ÍâhU/¤åŒ\V—n}qm7Õ³€¤ç(­õbO	¶şEê‘Ì¶W˜æ¦´Í¬äËªH!İ"Ø1l×áD“(øÕ£¦Ï×–íÎJ®£³+èQu¯^êåë4KM¬.Š±!ØDé!ÈO÷˜¿’+¢v·- VJÕh¾vRô‰²[–®e¡ ½”b_µ!ÓH‰ÃD®zuP¹˜Pz‹5¯árt­º §j¢&kL³åÍ}XîòCâ £˜R¤™±º[¤´&œ¡D´oÍ[HLçr+ÆU ß®ç,hU/9–³•*Û1p¸s?Ö‰NšXG~. \ï÷³´W¬»VÕlÜº"*{rÃvÚ»Ñµò“~9ù_Ğ%Ì£$è`a£ƒsjæb[/Ãå ºs¶M/›À7â  P8,K;Z‡e‘\wÿåæÅ5c¾Dä‘*±oDŠû…ÓtTÎ5aØ€ò¡[ü$ĞUşÖÍ‡H§¼Ê‡ÚÄd-©£*w®¾Å×à³ı-È@Û:t:l51÷¡c¡‰å¿`îÜü‚Ñ
¾X®5 ùı+ØÊ¨èï9ğLFêú«($b5I*Raõúâ39®J»,ØŠçöªg5eùG{~¡æXH5_Ûõvïj¬C[†9—È¯ÆÑd8Ã©¬¤Hò³@X‹ÕùfÍÜ\Ì#KÎ´`õÍ_iF´{J9__uú¤‹Iİ¯Í3‡ÅÓ­5]¹}B[,×ûTúcn^9<ÏÌ¸t™Òñ<XÙ7î¨é÷RQ)Ş_¥lì×Áä|2†2Qñ2Âø |ÖÆs˜z-¬Â+»cñº€/…¾g‡‰šáËLP9‚Úu'ßNFZQc`İ-sD§ÎÃc…Å.‘h)cBWáÅìxzş òÛŒ
ğå–u'çÛä|ÛzWä×¥]ıüÖ1Ÿ7ékÿ÷f©®êªw+ÓfXÚëHoùÀÃVÔ“\VÈA"±ËV¿§YëZzidæt}ê ‘µiæŒÒ7ı[ušxë…Q°¼Ş‚ñnç^%…h2¯2µÛéLWfÇ“T¼¡b2½¹.y*“‹¨Ì|¯kŠlªJ.L]ê°(…b¦ß< ?íÛÑÎ‘fê{YUfÂnO*^–›<2’"Ô÷n®Ï–ãHA¬5½b¹,ÓK}“Ü
.¨«ßŸ3Mc¢ûu¨§¹m‚òPğıŞvA-rÎSæ)YáifxGF¡&°”À5”¹¦Ü±HÙÌ2FDn±/~ÒRkTF­ªW¢Äî³%ÌÎC¤Å<¤ùĞ[ÛÊÛÚå¹2¹Áˆ¸²µ§O\ƒI_ŒHˆi#ßÆjuÎ\oÈ5åfÄ…³ª®¢œ3‡§)ÓÔ\óS‘ÒÉ'ºÒwiÏ°s‡Ó•ÆÂ\H‰§NU?ØU(wQ'>^ù¸)pÀ,;†¦Z¨Ôé-Nì³vbW1&ıÉ“|T(¸îÒ<:ô”Î !ÏQ¦ê°×ÃÓçÆ¤f33üT]äsò/¹ÒNXËòn$$äÊánnâ­2/vÁ´Ã¼—µwö>ÜHfUD`XçšÑ±	ÃöÿAjLá°EkĞšÚ%!K„›ßğ‘çk{îŞ§â©Ûø‚î·§•ÿ8ì„5Vó-Rue²&s&«ÌÉ\×ª~ñN@oŸİî/±ÿˆª·Ğ¡û6#¾'ÊÒäüîÓUdîü|;8IïÛñ‚d 9ºöfZ2XãÒË{fÕÅmAêÚÇpŠ3d)NV½+õHÎáR}’4Æà¹¯o@

5x—¬ï$"[v#p.Şn¾3õ¯ºòœ¶Æ®{óı“JşÉtFMîÂ˜w&I–Nyf²Ñ9b5O5{bcs~…WvÛ-¿ÈùåÚRg¦çÆL¸ÁµíÕ\°%·ARªøıßŸ[RtÜ™Šd¸nÍ3Óºv&ö .ï%-eÌwÛå©
?ãhåfuáJ­XŸ5:mÁÔÍê÷´ñ™ş¾Âo§:}÷·Nz;{şz™nËt¾2àÜËCB¤'Daai,YËå7¦]>lœù—.iª£élTªo&ÄÓpÎĞùÉğêÙıø%zÃHP¢5§Ô®Â˜&V‡—_j£³!„Ç¸X¶"Ü£Ÿ8d¦©"ƒ‰)T»±Ø/ÙŠwnŠC½Ş1?Ö˜)†ü½Îğ–EŸŞ>eœìluü	zQq1 Õ<(a£ß~ùGKd§ş…%’,ù¯i¹a® f‡w ³¬¶ø¨!¤çå€ƒ/™°†”@^óõóëKÆZ*¬¯€Ö—9)Ğ \V×Â*~¨Ï>˜º°#ûûzê–èÂSùíîÇó¼µî³´¬²ïfUvGqÔI¹ŠªJùWµ«Q-Õ”4Òãâ:›²>û…ù·²èÂÎáL±TOwüã™aÏî®wº_í°¯õ(z$Pç’ñÅÇ ’üÙ×)U+)äĞUXkû(ĞzPëBŸ½C–×Ü`w/Ğ£y§ğkÒÏ§\ì[G:sE£ïÃE“Ù šß<‡—ˆÉ*ËI_@!¦+."S_f« ı¡–¦Ó¡ö…çp±—^I‚_±‹QIĞzìV„Œ‰Şê†røh">‘Ú£ÚjöôÁ¸Pÿöª>q?°ÓØ­Ññ¦+(Ö—_ ²x?8?ÖI§ŞJ NÎåù®ø€“ƒÁ+üìÉJä^ÕÃŞë^Y}íÔ~sªZ;ÀVO\¼¶½ã¡_]ZDhgÄñ8%¨jHş§-<ñæìU·jËgátzûh«ˆh5ÁÅÛŠÿlÊvú×ıÑÏlÁì®K€Ú7¤¡kı¤3wÙrh1‘[²[—;ñú¸7’µ¶Yi””˜í{71 ÈÖqÍôŒµ‰¢{%L¢‘©¡G%/dŠ¥9Ş®áwÚìs—ã0Ş~n
[á*3æ%¶9?Mù#6ı0Öå”B6ÍŸËŒOùàO…}R³/`Œ·ç…Dë‘ òÏÀ×°²•£ k×3ç°öÙYæ—–ö÷Mó˜¢Ïjæ”'· è³Éİ¬mû+§Yéı£¸ùoèhéœp>4Ë} Ï“±¼q•93ÄÑ-PÒ"¼ÿ³düÿÄîÓa1—¹oV<¾PbÄ7´«8&Ä¨¦aï¦ç•c‰ØÑ³+yk—‹Çï¤İ{ó›İĞ­Û7Û7ö,ı"µ(«óJ»)Êo¼@Ø~€tğv?
G<Q¦§TÒÒHº”OÉfíà­ºå¿¡öìT‡˜™ÎA-i}£«Ò•Ô~Qq,Ò;ú™ğ®¹Šs pCà±n©#~ÄÙÏˆ,?úäúİ@Ú½a²dx…&ıê»õ†ı’qéYôß°_é
CÒ0Yhb±Ó(À.Ø£‰Ÿ/ö?×ğó?—í~âç?o“‘î	©#¤òÏG6+¸˜‡ÒôÛË î1¸öMN‚W ‹Äª.-A/Kæ	Ø”cZ?ßÛ|ê%B›ÆêŒ4%GoˆYôı$Î¿ã5òÀïLVø}îpÄù<àI Ÿ7áHàr*		”‚âtlªQ³ISÌîÜí>cGP[ü`±
PhÁÔîÑë<tRºº…¡j›Œäùgå¤ÏP@†~&¬v¨¬İìñcö8‰9úúttÉıø-R®]äïµ8šm3ÛpÆoèƒ]z´\ñ^——4«şX•Œ#:š¬ğÉÇ5ûÍîOë à^Âzó…C|‹5Õé˜ŞJÕøœV]¾bF³ŸØ,MTNØJu¯xaÍØ˜‘í~®­ùÈßtİhïq‡Ã¦k{W>—u;V•]Úf˜ 40ò~	>¥…½Qõk/ë$¦	o· nöBÌõmÈ«w_X{»Íƒ{_ƒğ}®óãJ <1l–=|Ê)<Ó«ÆZë ÷´»@ù}óäcy“šº=…Â‡Îjú #ÿ?ĞØéLğ3sÁH‘ùñËL˜'ë2².nSıDÚÉ<ê¸áÆœÚTL…Ş…[:©!İ¢MJ¡çJzIpF+ôá¼€ß)qß¯ã4¼+¤d·&D)ì7jÁìÅ_>×5Ô¥¨5Øvò×IêWÕ|¼uTJ»9ÙËöèTV£Isäº¬“!]ü!ÊÀßá-¦VË,ÿPã¸øÈéäôwV%=ıõy*Aè;V§»ÎUU€ë¢ûÿú2eªy`ägWëcÁÓXIÄÑfNøãÉXåŸÚ½ĞŞ°c¦Ôs¶¼/½ëYn3¯%}pL'n¢P>óQ”ìWë;Eá¬¯$yM/¿ş…K‰ªÜ²!œ¶-ju Qh®PaÊ
¨Íp¤Õgôà"à ‘B§ÖˆªÊ›°Ì7y?$JÌk±5'!Ü˜ºÏ2°bø’^81u•£g*îÍ'dC…7y\Û“^.„¢|€|>*³d_]Î­¦•š%–˜´ôëCcG{©µÜÅ»½yg™Õ„„%:‘¡^Ö¾·'İ3Ïº†–ûWağñDÔıË]O—Ëóšúmí„˜uk`şˆÇëÊĞ.õĞş†¸e]øop>+®1²÷ÉH„èÏ vv$wo º+ß˜¦çSTYqì›GÅ“ğÿ™gÙzŞJ°ß õÅ‹ˆnvèä)ïá´óó²mÓÇöü)â?ã2§~ë¶VÅïš6$ÃñÌz[îSjİ£w¦ğBA7XşİoAÇ{_Aë;6tW«Mğˆ'‹ P[\«Í	Âœ,?BÕgraDÁ•fãÉMù;U¬şji³($ï¼YGXe¿Î44Èa&]ÔÚÃzÅ®Ê…½ZwsZ‚bÀŞTaúŠšPšuŒ°ÅŸÕ2”¨Ê|^Ş¾* T;”(''/ş'ˆ‘6†fÄ«ÒšeäÃ‘	ã­IÔì¦;H¨Ë³íY¼‚µf‰ˆôÃwAú–ÊŞ(@ıv#â~=°{ù±¼/´³È•¾Ö%=d6ë®ì¸}29Ö"ÌÈé^^‹İ³Fv%|(Š‚ô‘íTÖª1!£
”E™4†¬o|õÙ›cÅrBb‘c-Ñ›îÏì‹“G%bo˜mÂÄÖ,i—ö…{L1G„‰^pfÍÌœõ¾A¿€lz2&˜ºÔãşv"ÅOIoœ“ú:OfÈKÆú1ÇœÙ„¸k·Š¹ç£†ˆi®íº_«Âê¤én`aŒ¤ÿÆã´ˆ;^ö†œ^Ü'FÔ}·e­ôåœ¥º8á+/FMÂƒr£®¬Y ìÏ90aı(WÅêl[ ÈğÒiŞ­êgŞÿy3/¸rø—	«›TkÒ‰éÅĞ’@KæRø4…ŠÑ’ia¹r`¥ÿØÇsACA…9oDy"ˆª,ÌüUù±¶	4#ìpf×å×ÆFW.6‚z	‰F,·6ªÓ83ùÔg0{¹ã´	à_µÊõ¤D–d·«ï!ú/ys™Mxœ{ØC‚D' Ø>ºÊÿ!ïÍ¶ÛÆ™¶ÑR¯¥yZûH„(Z–E‘Ç9s[óDÍºúÍª§@h;o÷7ıƒX$1£P3ªî¥	­ày†6˜ÜìYyCNoG}U™T»ëºÒ
aÎrE1ÓMV·È%¼[w$Ö xõuÉ«üpTì1 lFŒÎ‹Õ~ã¦q˜%Y³ßÔÅOvÈöã~,}gç†¯ÒXá¡Îûùˆ­ƒ&+lÅAâV%üóI'òñ-ÊĞ¹ß@¼Èxa(WCT_÷„ÉÈıÌ*jUpG¬Ê`ù”_Z€CZgş…ãÔ“ät1ÊÑ^˜÷ÍÏù°½cP˜‹%‹İÄı,ûõ6‘×9²ò3h$6Ù5‚f÷CüíÍ6—^..Ny}ÈäuŠXœ.Ù}ÈEåkÙxgdóË^Ù.è·ÜŞwFÀœ­Q•òŞˆÓ·¡di3#l}Ÿ|á•ÙÌ9µ]Ñ+ ñ—²èÃ8mI|u§%
9¥Şêb÷¡õ	"Ññ’@bu«:›9/ë‰ıex„m©,.“Q3ĞÜc8ÌcgØÙÅH>”‹Ör"7²¹V|#¯èerâx/Â¶yğòPŠ¶Y/ı•=!TÙˆrw›™Iæ•°¨pKÔÍ8Hj¢îDûn~ÜéBúÎE¨ÒŸ§Œ3%ê{%ÔŞk#¹ôAº¾°YÖŠ~»øÆfØEé}ŸŸáAŞªB7dvÍU«¾ñu\Bu7]Ü^µ»QÜn°o	şX#4äàŒĞƒÜ!ˆPÔgæ-Izã°Ï–T{!…1OÌçú©Tàşx“c©ÂW…ÖÌ ªŸ$VĞsXò¡­>Á×î8^ıÂ}z97’âdƒ7`lf/ÃœúúÕ@ãy,3³#	0TœY÷cÏÌ¬SÃ=–´ÂÜ;µ2O(^¾S$ÛÅv÷ğä³’M±ö
eºNö«Tq<s£9üîIõÅá<ø tˆH’ú…èa›|dÑqÊ‰"ë»"?¥ïˆ6‹×ÕşB¸½wö6(ÚcWé‡âÕwXğZLH»Ùü©wM6{›E¢Xx&Uj{áM±°ñ˜‰®ÒWÜ6Ô5a8Dèj«&o1&
Æ¬úŞähM›Jˆ3]âëğ‚Ò.Tõ?…ÒPçnÈ?€Ò ôe(ııA)Ğè,róm…\ áß S¿ªN¼ÉŞœ$—Å&¢C¶_.a·­³:4{Ã7şR&2t§ĞŸb!ğX|¿]çr¼Miet€b¬9)âÎë˜üªQœBOU˜²™äÇd–dË»•@§	f®‹š·„X¾Œä¸GT"Ô£”_Ú¹ªPÖ&·Å	÷QN°d¶•ÎŒjŞI^n»IV‡àVWM2ˆãÆ×±Â©Îö~µä}4	ZNò´‹1²Äº_Ä±t8£7f®j}Ö[#ËA÷/Kôš¤&\ä[|³@èïŸiär³?ñöÈğµ:v&ÜØ Õ¦µ|/fÀ=9ÁV‡k8îLH,4= ìdúµ:&¢BÿlXŞbO~|™`å‘]+À(ıŸctğ´İµ Ğ85‘ÒÃó$¬çN‰ûvVWz²I@sÃ¯f4(è¢Yä*²è“á³ôÖĞç±Ëâ˜³ú•Â”Òã7ò&~ĞUÈŒ¦Ï`´§“óÅÍ"Úà·!2ÜdX¨Îz£øîáÊÓû;æzììPçiÚá£2e¹™í_CÄq‡¸šåßØì'É«Yn®«¹KOû8âmâğš²6¸¼¼sWlKŞÇu…S+_æScŸù:u‘=Í5V1Ö½*8ÎN*úÇzÏŒ¼5y¾¼U†‹y¹Ê\ë=hf õEH»¼H" …ü·ÊkÌ¹èõ¿Ù·ÉæzyñúAá£„TîÈå‡Â†mU”½Ñ Ahµå×!Ì»Ä&ê…L‰ÛÎS	†¯'}Ùî×hß£T~QüKRËİß—e ôüÜx^qf„.[ckn¿®iDRÉd*WC|‰8ŞÄ†p_pİ@ÿdğE×H	P$\ó6ùG¾Ñ±›hœ¼4´v; ;ÕtFŞÚ\,jTó7—
i ç!­#Y#—Œè_iÉIu}XATËÀÿ«âİŒ<—íj§#{f‹ÖœY±Fùz r/¥{‚SO³ªÎbi‰Ê7'i
à`±°,0Ü@I¼‚K0ãUÉ¡¶G)gj÷ëj¥÷>ânn7ä¡–½‚ÇßŞjÛIEÓ:Ÿc½9‡s9ßvP-@ãLß_&ŸK:FõœŠár@"_ÁjúJn¸5á6‚j|ÏèïÛí…:€|×*J_T'}ßÜîqôA‚Î3‚Éôr8«_òxr®¾„|Ûò7¬…ĞâÖ6ŸvWyºÛT°ò7¡2Ù‚5È§´&ñËPJ¸n„Í¢³ìËêI«z#ï¼µĞºû?ÈÕÓ¨M–ÕmÒ¦Èæ­–#Z^sDMã7à{‘øÍ$m¼ˆ‹õöÂìšÌMoñAŞØë”s¹-Ü]ŠÆvwHS¢—ÊU h<±C¢¿IcMCˆCÙêÍ…Zna©8jó1‹)ë°ÓSÔ7Y­şƒÏ"r0×˜Ñ…B°-Ú$²æˆïK6¼5ŸQUÆÙZºÕ~ÌõwV€•ÿ¨¸-q¸`HZÒÈP0Ø]ô}•Ê¶Ã¤:{Ùì°7×æ 	=­ÇìfePµ­âÑø½m‰0S)0–æóæÿAö¾DI
<:îİÆ[â9š‰œÈ÷a¬lÃ˜èÙÂ­!¿D`òÏB˜GŠø¤\A&Şƒ	ÓŠˆu íæ[é+Á8Æ Á'ÒäÁWL_•‰³èØmP>1-@è2Şø•Ñ	«rc§½lØÿ—©ÀÏAÛ8ïß-s÷‹ä³Ù‰ˆ)çòw6…'K~‡5/!ÍÀ—€"ÀSQğŸ—’c52CY­.™HpÄFiTÁ^;ì ¸{ÙŒÅÙ'…c«¨ÛdÉÆ¸{ó°'V¼ª1¸U3Äeéñ÷¹º‹¦øx½:C[½½âh7(}úÂ¶3}ÒÄ®9X4¨yáWx\ËÁÇ»ÓŠ¡b‹c Ó¯½ıüåfÛÑºFà‹Ë3»Pû:ıMğ¦ù?ômôñgp©Øí†Ù¡ŞvòcÏÌ[Š¤v	óÖ%IEcY† éô•¾SŸsÆáû‚¥dÑN…­äòÿ ş ›¼†èZKºÉŒŒèå¹˜ÇTñ€0Ñ’¢ül³šAó%ãØ´Cl¦!ev×x5ôòSI°‘Ç–lö-‰‡/|´B/6ßÂ–Z0Ú™Cæ“	1É·bïAnÜ›µæ-ÂávM7Œs?<ÜÆMF¾½I€w‡[Ïˆ­C‡Ş‘ÍÆm²”œ{>á¼d8Më:kİ&ª,g÷ú¸çøğôêp—`ÿ…£=dQây–iAÁ×‰2-û%³ÁC(–ËœÚMí[Óÿ1â\³SØü²WÏ"ÒRŞ6ì¡§ı«Ã–0àè–½›o:§Ô•åå­Q}~]½8 ÙwÇ¸©ó@ö?4 mŞÆÑ%"Ö ºÔî”õ|¾_aO”†5Üù~áˆ^İÿäù ¿%ì58.ã˜œ?8&å»«c¢İsŞ=&KL$G+QmÈ¹ƒ‰ZÉÆy/a‚$Ÿ6.õ‡uÀ\öñ*,öİ´‡ğ}lhöâ’V¬'FG`°”£ç€*~Ø\²k}„¿Xw?Ighèº€ıçõ
ïÖú‚×9Yá¶œÛ¨êÿ×  áÚà9aøËbf£š£ÿìõttŒFĞ°¢å?tßü‘«Ã<'pC—©Ø5º¨Lœâ¶ÿÔ€U0	ñÂ–öÚç!ÕwğĞga²ƒ­ƒg)5Z´“&óy;.JHªW5zßµÍŠbG«{Y%ÅÒ3›gtÓ4I4-~}û™u\&7ÿÇ%Ù¯Ë‘¬\á¤¹3ÿ¿éÁpÁ;Ü¯áBŸ%@SÈY9:|„îERIñå˜û:¸¶ÿ†0Œy<ıÇ•µè¯³lÖà[ñV>ö $´lÚN˜ñ„ée&Éañ\\‰Åı7İÙæYû(¶ù
oó×:„¬ÉMl›ï7GS©Wâİé, Ö–Yvb.¸&\°æ+ÌÔµë¸r6X+øªR€¼èLÿˆ³@:vˆ’ß€Ó8FÔjß¼VÖ”_™õnèqu%î
F—|ªAf“§¨cQ[ÑŒùêùñf²1¤o¿õ?'÷9ä¨¿:êü†mxÜ±¥x`áâùÏè<õ=ªl|{¥Jò(ıß(°©şÖ£¼à«ÁåÛ€ÅO~{á{øöû“á²wÉGRQÍ”ñuÍaiä+)Ÿ®¯mÆ~^ãû¥=Á/#nQrõ›¤Õ~¬Óı*åúk}áûVª?H(b8¨=I0‘Î‹PÙ'ÎĞf+ğÃ…1‹òt+œÊP­ˆÛ„¼@=ŞxhöÈ yæ k\mö,¼¯ZÈšOŒgK0ôú÷[Ú£¥2rº…Eî•Mû¹-†ş˜àõ™ s\½Û<¯uûÔlË»nãvÔ_kD»«Ó;7Úì Š ÚAñ°O©ŞÚ÷H¢É³G¦³€qd÷‹àeÛÔA:õ’6p#uáá!¹-Ú¾…'Äìä~øQÜµë{ñÎÛ6“`<o	/UÛ#×­Î+…+ûN,!¬GE!T¹jª$5›¾'÷PG¥.V 4DÒogö·Â¹&n¥+‡¿S].oÖ˜úÉe!È5‹»|ŸÂXòX†ÆïGe"®[µØèàéœ9é@Sdi|Ùf}¾IçSöó¤İà‡P~&Íl#Á}:7;ïàSq}i&dwë‡ÕB_>fÜ¶0Ğÿì@âÛùİíD]l0'®^˜Ø< K}«±ÁUgsˆaV&•+Áç±õG+:ú­'W¡×K‘‰’«ÃÙó1 v¾¸I^3ƒS›m´º1ÿø‚É†…v}÷œC@İ& Ş§CØô€86€TYØ)Àth‹
‡| €'¡á¤¶ 4\É{û¼9ïãã3å‰ÈZT»V$Õğ¨8Å~‰GY ¦S–½fÒÚ#ó@ßõ`©€³:ŞÂçº^aÚ`\…ÚKz,À8¶ÆßA`lPùĞ1şÅ3¼7çÚıDm!‚ÄkšfzË²2ËÈıUrvCRàİ®-.²Ì÷,n™Ï)AEµútjRÏJ')§LÙ=bÂD<c*İ]İğ´†eõ¹VRîË©¡—FPô·ğ˜ÑH±?ÌcäóŸâ—#<’tÜ—£8eÒNíæñŒ3Ã©¹µ~¹€¼YŞ¬àJé/'œÒÇlrJá0`rOª
5Ş)õ´š?4ºUŸQÀI˜Ù¸Š>¦"Â‹™,0“¼v²¬xH…ràr~ù¼ìBá7ØbÊ™iÇ,C;s³NĞ.ÍZ¾\IÆéép™î)ÌCòŸŒ•ÑO›¯6‡\ ïêÉÕzs‰mT¯K':0_ÉùÆVS¹¯«éò[Ü¤Y¼™§oŠ@ÌE/ÔÙG_µCğ3(|7'á¢ĞJ{›iô'aáõÿ»(+P:t$ÿÊ-(qñïq4Ò‘À"ÈÚÙ5iñ´gA¿¬?ÿR®¬®¾ñÍìh3>ÅCoXjãÚ4¾öì¯´jñ·şå·Şç¾]µ9x§ŞKòmpùíõsßŞé/å…}M(E`4ùÚ8g¬gDÉ;sh4)R`»²¿—M!¼?ŠÆğØÆÕ
à”å,[Ñû­ÛL%†.´ßoÌ²p°7bçîÄStİŒ„€¦-uDÕg­dG	*q1ˆŠ5ˆĞ5ˆ`aPîEëovX³:Üşı>èpÃ"³î°~øl‡Ó¨Ã©ÕáXQl@¸½Óá9cİaöÓÎ£çV‡Ó¨ÃQëÃV‡£ãßîğéƒ×Y>6ÒaõÓ3\6)ëÙ!ñ“;½Ûc.Ëq:¥ÇÙ§§˜‹zÌY=ûøÏ?ê±%™Z÷¸øt…¨Ç‚ÕcxÜOôX²z\ı*(~!ñqÂ8Kn¤iyÑÂ…TVWaF˜æÊû×°ÚÌa¶°ÿ'/»˜Óò±PâÈ9_ÒÔJ¡ÁõJHxúu˜°ÿP$&n‹ìuù¼ÉÇŞúÁ)´‡ˆ§ÅÏ}ñ¬}dÀÕñ~ô~a)î¹Ö·ÀìgÕ?w3ùFÉ"§æÛ8bØ" ü9ã6 ìãí_bçĞI4ZæK¿“Ón,Oí&u\±&üæa|ì!5`0ˆD¤¯Ë_¹.AØ,0.×ÀFzL‡&Å§¼rC¼:yÕjrqh¡*Õ^3Ê•DìNU­ Û<‘ç°µÂMKÌù½‹‹¥PÉ¬­óNFÀ‘ªy‘i¤%5#‚İFòÁ~z`°>‚pşVíi¨W±ò´{ñL~Á®=· ÌD½|æ$ĞŞ´®pš'1Â×÷ä`¡¾æë[Ñù
Î^f+‘UÏpœÎóİ5ñÆpŞì%gãp­z“çø¡wÎÃ/–"¿»V4^Ğt¾â¶ÉJ^¯aøy/hbw”PÄ¡8stnõó„£ÃÏm`âÍË·WsvÃu¿$Âíh|o×_"Ld}ó¤#íµHË€G´=G};O›”7éú³`iÉA“ä Kàœ´HmÑn<ü†7áÚ\I“ĞCü&kÑœÛÚ=Co7ÒCBB™~®â¬ız«ŸÛìq¸Ñ>îCÖ‹@oÁáÅfµk%v:-·Ì]ÕhûiC|:ªè3~5Ø]díÍ ®ƒ¼¤“te1`´T±¥ƒ»É•û±¼¼á‘[úµ÷uøå9ÚGc‹\´ŠË$ykãüé?lâ\³o]«D«—İ&	Os¨7G¡yËSqÀ¬ùEĞBbiWŒ¿–_0å¶#4õ¸á~,¡u)ŒÎæÍ”¿Qí´¾½¨\6Ÿà*L³¨oP²}"îjã5¾…u¬ã3l’+^SÔƒCä›’i,D7_yÁrˆ®ò ë~ê¨ÀRÎúÖäêÈ‘3°øÑn63›`¢í„£„­™­ªXÌéšJÉ‹‚j¤ÈßŸ£YB×/6Ø½®	ŸIışã@l9’Z$D5‡* !è‘Jç±•mÎ`Zrd"1=éË÷$š‰%„‚ä‡Mãs°»ä3éıÎæçµâèvò™Ó%™ŸkŠmÇm8ÅÌéú¨ïjœ?GûÅ?¨½ió©?"*Wµ>+öÕŸ="ıÆçÓU’ÏœCóİ¡©âÔ"(§|Ş]®Ú´IìNü™"ûù®EåÏ9¾bîX“S‰Ëç5ñ-P{‡ÜUò™,õæçç=oÒ%`Æ6 Ü?E³ïƒb­¶Ô